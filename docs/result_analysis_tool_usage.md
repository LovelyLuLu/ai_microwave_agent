# HFSS结果分析工具使用指南

## 概述

`ANALYZE_HFSS_RESULTS` 工具是基于 `scripts/result.py` 开发的 LangChain 工具，用于分析已完成的 HFSS 仿真结果。该工具提供了全面的 S 参数分析、VSWR 计算、关键性能指标提取等功能。

## 主要功能

### 1. S参数分析
- **幅度和相位图**: 自动生成 S 参数的幅度（dB）和相位（度）图表
- **多参数支持**: 支持分析 S(1,1)、S(2,1)、S(1,2)、S(2,2) 等任意 S 参数
- **高质量图像**: 生成 300 DPI 的 PNG 格式图像，适合论文和报告使用

### 2. VSWR分析
- **电压驻波比计算**: 基于反射参数（S11、S22等）计算 VSWR
- **自适应缩放**: 智能调整 Y 轴范围，确保图表清晰可读
- **多端口支持**: 支持多端口器件的 VSWR 分析

### 3. 关键指标计算
- **回波损耗**: 自动计算反射参数的回波损耗（Return Loss）
- **插入损耗**: 自动计算传输参数的插入损耗（Insertion Loss）
- **谐振频率**: 识别并报告谐振频率点
- **统计信息**: 提供最小值、最大值、平均值等统计数据

### 4. 数据导出
- **CSV格式**: 导出原始仿真数据，便于进一步处理
- **JSON格式**: 导出结构化数据，包含频率、实部、虚部信息
- **指标报告**: 生成包含所有关键指标的 JSON 报告

## 参数说明

### 必需参数
- `setup_name`: 分析设置名称（默认: "MainSetup"）
- `sweep_name`: 扫频设置名称（默认: "BroadbandSweep"）

### 可选参数
- `project_path`: HFSS项目文件路径（默认: 自动查找最新项目）
- `s_parameters`: 要分析的S参数列表（默认: ["S(1,1)", "S(2,1)", "S(1,2)", "S(2,2)"]）
- `generate_plots`: 是否生成图表（默认: true）
- `export_data`: 是否导出数据文件（默认: true）
- `calculate_vswr`: 是否计算VSWR（默认: true）
- `calculate_metrics`: 是否计算关键指标（默认: true）
- `output_dir`: 结果输出目录（默认: 项目根目录下的results文件夹）

## 使用方法

### 通过Agent调用（推荐）

#### 基本使用
```bash
python app/agent_build.py --input "分析最新的HFSS仿真结果"
```

#### 指定参数
```bash
python app/agent_build.py --input "分析HFSS结果，只需要S11和S21参数"
```

#### 自定义设置
```bash
python app/agent_build.py --input "分析MainSetup的BroadbandSweep结果，生成VSWR图和关键指标报告"
```

### 交互模式
```bash
python app/agent_build.py --interactive
```
然后输入自然语言指令：
- "请分析刚才仿真的结果"
- "我需要看S参数的幅度和相位图"
- "计算这个器件的VSWR和回波损耗"
- "导出仿真数据到CSV文件"

## 输出文件

所有结果文件默认保存在 `results/` 文件夹中：

### 图像文件
- `S_1_1.png`: S(1,1)参数的幅度和相位图
- `S_2_1.png`: S(2,1)参数的幅度和相位图
- `S_1_2.png`: S(1,2)参数的幅度和相位图
- `S_2_2.png`: S(2,2)参数的幅度和相位图
- `VSWR.png`: VSWR分析图

### 数据文件
- `s_parameters.csv`: 原始S参数数据（CSV格式）
- `s_parameters.json`: 结构化S参数数据（JSON格式）
- `analysis_metrics.json`: 关键指标分析报告（JSON格式）

## 应用场景

### 1. 微波器件性能评估
- 滤波器频率响应分析
- 天线阻抗匹配评估
- 传输线特性分析

### 2. SRR/CSRR结构分析
- 谐振频率识别
- 品质因子计算
- 传输特性评估

### 3. 学术研究
- 论文图表生成
- 实验数据导出
- 性能指标对比

## 工作流程

1. **项目识别**: 自动查找最新的HFSS项目文件
2. **数据提取**: 从指定的分析设置和扫频中提取S参数数据
3. **图表生成**: 创建高质量的S参数和VSWR图表
4. **指标计算**: 计算回波损耗、插入损耗、VSWR等关键指标
5. **数据导出**: 将结果保存为多种格式的文件
6. **报告生成**: 提供详细的分析摘要

## 完整工作流程示例

```
用户: "创建一个CSRR结构，外环外半径3.5mm，环宽度0.6mm"
Agent: [调用CREATE_CSRR] → "CSRR结构已创建，需要现在开始仿真吗？"

用户: "是的，仿真频率范围1-10GHz，步长0.01GHz"
Agent: [调用RUN_SIM] → "仿真已完成，需要分析结果吗？"

用户: "分析S参数和VSWR，生成图表和数据文件"
Agent: [调用ANALYZE_HFSS_RESULTS] → "分析完成！生成了S参数图、VSWR图和数据文件"
```

## 技术细节

### 依赖库
- `ansys.aedt.core`: PyAEDT核心库
- `matplotlib`: 图表绘制
- `numpy`: 数值计算
- `pydantic`: 参数验证
- `langchain`: 工具框架

### 数据处理
- **复数处理**: 正确处理S参数的实部和虚部
- **单位转换**: 自动处理频率单位（GHz）
- **数值稳定性**: 避免除零和对数运算错误

### 图表特性
- **高分辨率**: 300 DPI输出，适合出版质量
- **专业样式**: 网格线、图例、标签完整
- **自适应布局**: 自动调整图表尺寸和比例

## 故障排除

### 常见问题

1. **找不到项目文件**
   - 确保HFSS项目已保存
   - 检查项目文件路径是否正确
   - 验证项目文件未被其他程序占用

2. **数据提取失败**
   - 确认分析设置名称正确
   - 检查扫频设置是否存在
   - 验证仿真是否已完成

3. **图表生成错误**
   - 检查matplotlib是否正确安装
   - 确认results目录有写入权限
   - 验证数据维度是否匹配

### 调试建议

1. **启用详细日志**: 工具会输出详细的执行信息
2. **检查中间文件**: 查看生成的JSON文件确认数据正确性
3. **分步执行**: 可以分别测试数据提取、图表生成等功能

## 性能优化

- **内存管理**: 大数据集时自动优化内存使用
- **并行处理**: 多个S参数可并行处理
- **缓存机制**: 避免重复计算相同数据

---

*本工具基于PyAEDT库开发，遵循ANSYS HFSS的标准数据格式和分析方法。*